{% extends 'shop/master/base.html' %}


{% block css %}
    <link type="text/css" rel="stylesheet" href="/static/js/layer/skin/layer.css">
{% endblock %}

{% block page_content %}
    <div class="main greyf5f5f5">
        <form id="cartForm">
            <div class="minwidth marT40">
                <ul class="buySerList bordere0e0e0">
                    <li class="shopp-list">
                        <div class="shoppTitle">
                            <ol class="shoppFirst">
                                <li class="goods">商品信息</li>
                                <li class="unit-price">单价</li>
                                <li class="shopp-num">数量</li>
                                <li class="shopp-subtotal">小计</li>
                                <li class="operation">操作</li>
                            </ol>
                        </div>
                        {% for k,v in shop_list.items %}
                            {% if v.name %}
                                <ol>
                                    <li class="goods">
                                        <div class="textImgSeparation goods-text">
                                            <div>
                                                <span>{{ v.name.p_name }}</span>
                                            </div>
                                            <div class="area">
                                                <em>地区：</em>
                                                <span>北京-朝阳区</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="unit-price">
                                        <span>{{ v.name.p_price }}元</span>
                                    </li>
                                    <li class="shopp-num">
                                        <div class="numAddSubtract overflowhidden">
                                            <a class="subtract notChoose productReduce">-</a>
                                            <input class="t-productNum" value="{{ v.number }}" name="number"
                                                   style="width:40px;"
                                                   category="product" p_price="{{ v.name.p_price }}" vprice="0"
                                                   nid="{{ k }}" type="text">
                                            <a class="productAdd">+</a>
                                        </div>
                                    </li>
                                    <li class="shopp-subtotal">
                                        <span class="productTotalPrice">{% widthratio v.number 1 v.name.p_price %}元</span>
                                    </li>
                                    <li class="operation">
                                        <a class="shop_delete" nid="{{ k }}">删除</a>
                                    </li>
                                </ol>
                            {% endif %}
                        {% endfor %}
                    </li>
                </ul>
            </div>
            <div class="minwidth">
                {% csrf_token %}
                <div class="floatRight marT30 checkoutWrap marB40" style="position:relative;">
                    <ul class="checkout floatRight">
                        <li>
                            <span class="checkout-le">金额合计：</span>
                            <span id="totalPrice" class="checkout-ri">元</span>
                        </li>
                        <li>
                            <span class="checkout-le">代金券抵扣：</span>
                            <span id="couponPrice" class="checkout-ri">0元</span>
                        </li>
                        <li>
                            <span class="checkout-le">应付总额：</span>
                        <span class="checkout-ri">
                        <em id="totalPayPrice">{{ shop_list.price }}元</em>
                        </span>
                        </li>
                    </ul>
                    <div class="marT30 floatRight">
                        <a id="orderButton" class="butpadding64 inlineBlock floatRight butRed"
                           href="{% url 'shopping_pay' %}">去结账</a>
                        <a class="butpadding21 inlineBlock floatRight butWhiteGreyborder marR20">继续购物</a>
                    </div>
                    <div class="invoiceWrap">
                        <div class="invoiceTip">
                            如何获取发票？
                            <div class="invoiceInner" style="display: none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script src="/static/js/jquery-3.1.1.js"></script>
    <script src="/static/js/layer/layer.js"></script>
    <script>
        $(function () {
            BindAddNumber();
            BindReduceNumber();
            BindTotalPrice();
            BindProductNumber();
            BindHover();
            BindDelete()

        });
        // 自动计算总价
        function BindTotalPrice(product_id, number) {
            var p_sum = 0;
            $('.productTotalPrice').each(function () {
                var c_price = $(this).text();
                c_price = c_price.substring(0, c_price.length - 1);
                p_sum += c_price * 1;
            });
            $('#totalPrice').text(p_sum + '元');
            var p_total = 0;
            p_total = $('#totalPrice').text().replace('元', '') * 1 + $('#couponPrice').text().replace('元', '') * 1
            $('#totalPayPrice').text(p_total + '元');
            data = {'product_id': product_id, 'number': number, 'price': p_total};
            {#            data = {'price': p_total};#}
            SendAjax(data)

        }
        // 减少购买数量
        function BindReduceNumber() {
            $('.shopp-list').on('click', '.productReduce', function () {
                var number = $(this).next('.t-productNum').val();
                var product_id = $(this).next('.t-productNum').attr('nid');
                var cprice = $(this).next('.t-productNum').attr('p_price');
                if (number == 1) {
                }
                else {
                    number = number * 1 - 1;
                    $(this).next('.t-productNum').val(number);
                    $(this).parent().parent().next('.shopp-subtotal').children('.productTotalPrice').text(cprice * 1 * number + '元')
                    BindTotalPrice(product_id, number);
                }
            })
        }
        // 增加购买数量
        function BindAddNumber() {
            $('.shopp-list').on('click', '.productAdd', function () {
                var number = $(this).prev('.t-productNum').val();
                var product_id = $(this).prev('.t-productNum').attr('nid');
                var cprice = $(this).prev('.t-productNum').attr('p_price');

                number = number * 1 + 1;
                $(this).prev('.t-productNum').val(number);
                $(this).parent().parent().next('.shopp-subtotal').children('.productTotalPrice').text(cprice * 1 * number + '元')
                BindTotalPrice(product_id, number);
            })
        }

        // 购买数量发生变化计算总价
        function BindProductNumber() {
            $('.shopp-list').on('input propertychange', '.t-productNum', function () {
                var number = $(this).val();
                var cprice = $(this).attr('p_price');
                $(this).parent().parent().next('.shopp-subtotal').children('.productTotalPrice').text(cprice * 1 * number + '元')
                BindTotalPrice()
            })
        }

        // tips
        var differentindex = '';
        function BindHover() {
            $('.invoiceTip').hover(function () {
                openMsg();
            }, function () {
                layer.close(differentindex);
            });
        }
        function openMsg() {
            differentindex = layer.tips('1、 服务完成后90天内，可联系客服索取发票。', '.invoiceTip', {
                tips: [1, ''],
                time: 4000
            })
        }

        // 发送最新的购买数量ajax
        function SendAjax(data) {
            url = '/cart_number.html';
            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                dataType: "json",
                success: function (arg) {
                }
            })
        }

        // 购物车删除
        function BindDelete() {
            $('#cartForm').on('click', '.shop_delete', function () {
                id = $(this).attr('nid');
                url = '/cart_del/' + id + '.html';
                var ths = this;
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (arg) {
                        console.log(arg['status']);
                        console.log(arg['status'] == 200);
                        if (arg['status'] == 200) {
                            console.log($(ths).parent().parent());
                            $(ths).parent().parent().attr('class', 'hide')
                        }
                    }

                })
            })
        }
    </script>
{% endblock %}